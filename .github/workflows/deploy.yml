name: Automatic deploy

on:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ›Ž Check out master
        uses: actions/checkout@master
        with:
          fetch-depth: 1
          submodules: true
      - name: ðŸ”¨ Set up Node
        uses: actions/setup-node@v1
        with:
          node-version: 12.x
      - name: ðŸ”§ Install tools
        run: |
          sudo apt install curl jq
          npm install postcss-cli autoprefixer
      - name: ðŸ¤µ Install latest Hugo
        run: |
          HUGO_VERSION=$(curl -s https://api.github.com/repos/gohugoio/hugo/releases/latest | jq -r '.tag_name')
          mkdir tmp/ && cd tmp/
          curl -sSL https://github.com/gohugoio/hugo/releases/download/${HUGO_VERSION}/hugo_extended_${HUGO_VERSION: -6}_Linux-64bit.tar.gz | tar -xvzf-
          sudo mv hugo /usr/local/bin/
          cd .. && rm -rf tmp/
          hugo version
      - name: ðŸ¤µ Build the pages
        run: |
          mkdir out
          hugo -d out
      - name: Copy file via scp
        uses: appleboy/scp-action@master
        env:
          HOST: ${{ secrets.DEPLOY_HOST }}
          USERNAME: ${{ secrets.DEPLOY_USER }}
          KEY: ${{ secrets.DEPLOY_KEY }}
        with:
          source: "out/*"
          target: "html/v2"
          strip_components: 1


