name: Automatic deploy

on:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ›Ž Check out master
        uses: actions/checkout@master
        with:
          fetch-depth: 1
          submodules: true
      - name: ðŸ”¨ Set up Node
        uses: actions/setup-node@v1
        with:
          node-version: 12.x
      - name: ðŸ”§ Install tools
        run: |
          sudo apt install curl jq openssh-client
          npm install postcss-cli autoprefixer
      - name: ðŸ¤µ Install latest Hugo
        run: |
          HUGO_VERSION=$(curl -s https://api.github.com/repos/gohugoio/hugo/releases/latest | jq -r '.tag_name')
          mkdir tmp/ && cd tmp/
          curl -sSL https://github.com/gohugoio/hugo/releases/download/${HUGO_VERSION}/hugo_extended_${HUGO_VERSION: -6}_Linux-64bit.tar.gz | tar -xvzf-
          sudo mv hugo /usr/local/bin/
          cd .. && rm -rf tmp/
          hugo version
      - name: ðŸ¤µ Build the pages
        run: |
          mkdir out
          hugo -d out
      - name: ðŸš€ Deploying via scp
        run: |
          echo ${{ secrets.DEPLOY_KEY }} >> action.key
          cd out
          scp -o "StrictHostKeyChecking no" -i ../action.key -p * ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:html/.
          cd ..
          rm action.key

